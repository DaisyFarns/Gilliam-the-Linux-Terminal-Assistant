#!/bin/bash

# Disable history expansion in Bash
set +H

AGENT_NAME="terminal-agent"
INSTALL_DIR="$HOME/.config/$AGENT_NAME"
SCRIPT_PATH="$INSTALL_DIR/$AGENT_NAME.py"
SYMLINK_PATH="/usr/local/bin/$AGENT_NAME"

function install_agent() {
    echo "[*] Installing $AGENT_NAME..."

    # Step 1: Create hidden install directory
    mkdir -p "$INSTALL_DIR"

    # Step 2: Create Python agent file with full core
    cat << 'EOF' > "$SCRIPT_PATH"
#!/usr/bin/env python3
import os
import sys
import subprocess
import readline
from datetime import datetime

BANNER = r"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ðŸ§  TERMINAL AGENT: ONLINE       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

HELP_TEXT = '''
COMMAND MODES:
â€¢ Any terminal command â†’ Executes normally.
â€¢ Question (contains '?' or starts with what/how/why) â†’ Explains using man pages or built-in help.
â€¢ 'exit' or 'quit' â†’ Ends the session.
'''

def is_question(text):
    lowered = text.lower()
    return '?' in text or lowered.startswith(('what', 'how', 'why', 'help', 'explain'))

def get_manual_info(cmd):
    try:
        man_output = subprocess.check_output(['man', cmd], stderr=subprocess.DEVNULL).decode()
        print("\nðŸ“– Showing manual info (first 20 lines):\n")
        print("\n".join(man_output.splitlines()[:20]))
    except Exception:
        print("âŒ No manual entry found.")

def execute_command(cmd):
    try:
        subprocess.run(cmd, shell=True)
    except Exception as e:
        print(f"ðŸ”¥ Command failed: {e}")

def main():
    print(BANNER)
    print("Type a command or ask a question. Type 'exit' to quit.")
    print(HELP_TEXT)

    api_key = load_api_key()
    if api_key:
        print("ðŸ”‘ OpenAI API key loaded: GPT support is ENABLED.")
    else:
        print("âš ï¸ No OpenAI API key found. GPT support is DISABLED.")

    while True:
        try:
            cmd = input("agent> ").strip()
            if cmd.lower() in ['exit', 'quit']:
                print("ðŸ‘‹ Agent signing off.")
                break
            elif not cmd:
                continue
            elif is_question(cmd):
                if api_key:
                    print("ðŸ§  GPT says:\n" + ask_gpt(cmd, api_key))
                else:
                    parts = cmd.strip().split()
                    target = parts[-1]
                    get_manual_info(target)
            else:
                execute_command(cmd)
        except KeyboardInterrupt:
            print("\nðŸ›‘ Ctrl+C received. Agent shutting down.")
            break

if __name__ == "__main__":
    main()
EOF

    chmod +x "$SCRIPT_PATH"

    # Step 3: Symlink to /usr/local/bin
    if [ -L "$SYMLINK_PATH" ]; then
        echo "[*] Removing existing symlink..."
        sudo rm "$SYMLINK_PATH"
    fi

    echo "[*] Creating symlink..."
    sudo ln -s "$SCRIPT_PATH" "$SYMLINK_PATH"

    echo "[âœ“] Installation complete! You can now run it using:"
    echo "    $AGENT_NAME"
}

# Auto-detect if not already running from saved file
if [[ "$(basename "$0")" != "install-terminal-agent.sh" ]]; then
    TMP_SCRIPT="/tmp/install-terminal-agent.sh"
    tail -n +1 "$0" > "$TMP_SCRIPT"
    chmod +x "$TMP_SCRIPT"
    exec "$TMP_SCRIPT"
else
    install_agent
fi
